<!doctype html>
<html ng-app="myApp">
    <head>
        <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.3.10/angular.min.js"></script>
        <script src="https://cdn.firebase.com/js/client/2.1.1/firebase.js"></script>
        <script src="https://cdn.firebase.com/libs/angularfire/0.9.2/angularfire.min.js"></script>
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-cookie/1.4.1/jquery.cookie.min.js"></script>
        <script src="js/game.js"></script>

        <link rel='stylesheet' href='css/firebase.css'/>
        <link rel='stylesheet' href='css/handanimation.css'/>
        <link rel='stylesheet' href='css/style.css'/>
        <link rel='stylesheet' type='text/css' media='all' href='css/animate.css'/>
    </head>

    <body ng-controller="MyController">
        <!-- TODO: Add an input that accepts a Game id so players can join a game -->
        <!-- TODO: Show Start Game only when a Game has been created or joined -->
        <!-- TODO: Show text that displays whether or not the player has won -->
        <!-- TODO: Query username to make sure it's unique within a game -->
        <!-- TODO: Add a PREGAME view. -->
        <!-- TODO: Deduct points if a user does not input a lie. -->



        <div id="join" class="hide">
            <div id="login">
                <input type="text" ng-model='input_username' placeholder="Enter lobby code"/>
                <input type="button" value="Join" ng-click="onJoinGameClicked()"/>
            </div>
        </div>

        <div id= 'pregame' class='center'>
            <img src="http://blog.flamingtext.com/blog/2015/03/09/flamingtext_com_1425864309_282458501.png" border="0" alt="Logo Design by FlamingText.com" title="Logo Design by FlamingText.com">
            <br>
            <br>
            <input type="button" value="Start Game" ng-click="startGame()"/>
            <input type="button" value="Create Game" ng-click="createGame()"/>
            <input type="button" value="Join Game" ng-click="joinGame()"/>
        </div>

        <div id= 'lobby' class='example chat l-demo-container init'>
            <header>Welcome {{ username }} : Game {{ game.$id }}</header>

            <div id="question" class='example-chat-toolbar' ng-model='question'>
                {{ question }}
            </div>
            <div id="gameover" class="hide">
                GAME OVER.
            </div>

            <div id="waiting" class="hide">
                Waiting for other players...
                <div class="loading">
                    <div class="finger finger-1">
                        <div class="finger-item">
                            <span></span><i></i>
                        </div>
                    </div>
                    <div class="finger finger-2">
                        <div class="finger-item">
                            <span></span><i></i>
                        </div>
                    </div>
                    <div class="finger finger-3">
                        <div class="finger-item">
                            <span></span><i></i>
                        </div>
                    </div>
                    <div class="finger finger-4">
                        <div class="finger-item">
                            <span></span><i></i>
                        </div>
                    </div>
                    <div class="last-finger">
                        <div class="last-finger-item"><i></i>
                        </div>
                    </div>
                </div>
            </div>

            <div id="answer" class="hide">
                The correct answer is: <strong>{{ answer }}</strong>
                <hr/>
            </div>

            <div id="options_container" class="buttons hide">
                <input ng-repeat="(_, choice) in choices" id="displayLies" type="button" value="{{ choice }} " class="button" ng-click="vote(this)"/>
            </div>

            <ul id="users">
                <li ng-repeat="(username, points) in users">{{ username }}, {{ points }}</li>
            </ul>

            <footer>
                <input id="lie" ng-model='inputLie' ng-keydown="enterLie($event)" type='text' id='messageInput'  placeholder='Type a lie...' class="hide">
                <div>
                    Timer: <span id="time">10</span>
                </div>
            </footer>
        </div>

        <div id="app" class="init example-chat l-demo-container hide">
            <header>Welcome {{ username }} : Game {{ game.$id }}</header>

            <div id="question" class='example-chat-toolbar' ng-model='question'>
                {{ question }}
            </div>
            <div id="gameover" class="hide">
                GAME OVER.
            </div>

            <div id="waiting" class="hide">
                Waiting for other players...
                <div class="loading">
                    <div class="finger finger-1">
                        <div class="finger-item">
                            <span></span><i></i>
                        </div>
                    </div>
                    <div class="finger finger-2">
                        <div class="finger-item">
                            <span></span><i></i>
                        </div>
                    </div>
                    <div class="finger finger-3">
                        <div class="finger-item">
                            <span></span><i></i>
                        </div>
                    </div>
                    <div class="finger finger-4">
                        <div class="finger-item">
                            <span></span><i></i>
                        </div>
                    </div>
                    <div class="last-finger">
                        <div class="last-finger-item"><i></i>
                        </div>
                    </div>
                </div>
            </div>

            <div id="answer" class="hide">
                The correct answer is: <strong>{{ answer }}</strong>
                <hr/>
            </div>

            <div id="options_container" class="buttons hide">
                <input ng-repeat="(_, choice) in choices" id="displayLies" type="button" value="{{ choice }} " class="button" ng-click="vote(this)"/>
            </div>

            <ul id="users">
                <li ng-repeat="(username, points) in users">{{ username }}, {{ points }}</li>
            </ul>

            <footer>
                <input id="lie" ng-model='inputLie' ng-keydown="enterLie($event)" type='text' id='messageInput'  placeholder='Type a lie...' class="hide">
                <div>
                    Timer: <span id="time">10</span>
                </div>
            </footer>
        </div>
    <script>
        /*var showLogin = function(show) {
            if (show) {
                $("#login").removeClass("hide");
                $("#app").addClass("hide");
            } else {
                $("#login").addClass("hide");
                $("#app").removeClass("hide");
            }
        }*/

        var id = "-JhWr1YifZ_GoNuUE1ig";
        var username;
        //showLogin(true);

        // Check if a username exists
        if (document.URL.indexOf(".html") >= 0) {
            username = "LocalUser";
            //showLogin(false);
        } else {
            username = $.cookie('sucker');
            if (username) {
                //showLogin(false);
            }
        }

        var game;

        var update = function() {
            console.log("update");
            if (game && game.state != Game.State.PREGAME) {
                console.log(game.state);
                var timer = game.update(new Date().getTime());
                $("#time").html(Math.max(0, timer));
            }
        }
        setInterval(update, 750);

        var myApp = angular.module("myApp", ["firebase"]);
        myApp.controller('MyController', ['$scope', '$firebase',
            function($scope, $firebase) {
                var addPoints = 0;

                $scope.username = username;
                var sucker = new Firebase("https://sucker.firebaseio.com");

                $scope.createGame = function() {
                    $("#pregame").addClass("hide");
                    $('#lobby').removeClass('init');
                    $("#gameover").addClass("hide");
                    $("#app").removeClass("hide");
                    $("#startButton").addClass("hide");
                    $("#waiting").addClass("hide");
                    
                    var gameReference = sucker.child("game");
                    var newGame = gameReference.push({
                        round: -1,
                        users: {username: {points: 0}}
                    });

                     // TODO: Hacky =\. We just want this game as an object.
                    var id = newGame.path.u[1];
                    var ref = new Firebase("https://sucker.firebaseio.com/game/" + id);
                    $scope.game = $firebase(ref).$asObject();
                    game = new Game(username, $scope.game, 4);

                    $.getJSON("https://sucker.firebaseio.com/questions.json",
                        function(data, status, xhr) {
                            // TODO: randomize, but make sure it only gets set *once*
                            var questions = [];
                            for (var i = 0; i < 4; ++i) {
                                questions[i] = data[i];
                            }

                            game.setQuestions(questions);
                            game.setStateCallbacks({
                                "PREGAME" : $scope.showWaiting,
                                "STARTED" : $scope.showWaiting,
                                "INPUT_LIE" : $scope.showEnterLie,
                                "VOTE" : $scope.showChoices,
                                "DISPLAY_RESULTS" : $scope.showResults,
                                "GAMEOVER" : $scope.showGameOver
                            });
                        }
                    );
                }
                /*$scope.joinGame = function() {
                $scope.joinGame = function() {
                    $("#pregame").addClass("hide");
                    game = new Game(username, $scope.game, 4);
                    $scope.users = game.users;
                    console.log(game.users);
                }*/

                /*$scope.onJoinGameClicked = function() {
                    var input = $scope.input_username;
                    if (input) {
                        username = input;
                        $.cookie('sucker', username, { expires: 7, path: '/' });
                        showLogin(false);
                        $scope.joinGame();
                    } else {
                        alert("You need a username.");
                    }
                }*/

                $scope.joinGame = function() {
                    $("#join").removeClass("hide");
                    $("#startButton").addClass("hide");
                    $("#createButton").addClass("hide");
                    $("#joinButton").addClass("hide");
                }

                $scope.startGame = function() {
                    console.log("Starting game..");
                    $("#pregame").addClass("hide");
                    $("#app").removeClass("init");
                    $("#gameover").addClass("hide");
                    $("#app").removeClass("hide");
                    $("#startButton").addClass("hide");
                    $("#waiting").addClass("hide");


                    // TODO: Use Firbase's server time because not everyone's
                    // computer will sync perfectly
                    var date = new Date();
                    var time = date.getTime();

                    var times = {};
                    // for each round
                    // TODO: remove magic numero 4
                    for (var round = 0; round < 4; ++round) {
                        if (round) {time += 10000;}
                        times[time] = {state: Game.State.INPUT_LIE, round: round};

                        time += 10000;
                        times[time] = {state: Game.State.VOTE, round: round};

                        time += 10000;
                        times[time] = {state: Game.State.DISPLAY_RESULTS, round: round};
                    }

                    // GAMEOVER
                    time += 10000;
                    times[time] = {state: Game.State.GAMEOVER, round: 4}; // TODO: magic #
                    console.log(times);
                    game.setTimes(times);
                    game.start();
                    $scope.showEnterLie();
                }

                $scope.showEnterLie = function() {
                    console.log("$scope.showEnterLie");

                    $("#gameover").addClass("hide");
                    $("#waiting").addClass("hide");
                    $("#answer").addClass("hide");
                    $("#lie").removeClass("hide");
                    $("#options_container").addClass("hide");
                    $scope.question = game.getQuestion();
                    $scope.choices = game.getChoices();
                }

                $scope.enterLie = function(e) {
                    if (e.keyCode === 13 && $scope.inputLie) {
                        $scope.choices = game.getChoices();
                        $scope.choices[username] = $scope.inputLie;
                        $scope.game.$save();
                        $scope.inputLie = "";
                        $scope.showWaiting();
                    }
                }

                $scope.showWaiting = function() {
                    $("#gameover").addClass("hide");
                    $("#waiting").removeClass("hide");
                    $("#answer").addClass("hide");
                    $("#lie").addClass("hide");
                    $("#options_container").addClass("hide");
                }

                $scope.showChoices = function() {
                    console.log("$scope.showChoices");

                    $scope.choices = game.getChoices();
                    $("#gameover").addClass("hide");
                    $("#waiting").addClass("hide");
                    $("#answer").addClass("hide");
                    $("#lie").addClass("hide");
                    $("#options_container").addClass("option animated bounceInDown");
                    $("#options_container").removeClass("hide");
                }

                $scope.vote = function(e) {
                    if (game.getAnswer() == e.choice) {
                        addPoints = 100;
                    }
                    $scope.showWaiting();
                }

                $scope.showResults = function() {
                    console.log("$scope.showResults");
                    $scope.users = game.addPoints(addPoints);
                    addPoints = 0;
                    $scope.answer = game.getAnswer();

                    $("#gameover").addClass("hide");
                    $("#waiting").addClass("hide");
                    $("#answer").removeClass("hide");
                    $("#lie").addClass("hide");
                    $("#options_container").addClass("hide");
                }

                $scope.showGameOver = function() {
                    $("#gameover").removeClass("hide");
                    $("#waiting").addClass("hide");
                    $("#answer").addClass("hide");
                    $("#lie").addClass("hide");
                    $("#options_container").addClass("hide");
                }

      }]);
    </script>
    </body>
</html>
