<!doctype html>
<html ng-app="myApp">
    <head>
        <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.3.10/angular.min.js"></script>
        <script src="https://cdn.firebase.com/js/client/2.1.1/firebase.js"></script>
        <script src="https://cdn.firebase.com/libs/angularfire/0.9.2/angularfire.min.js"></script>
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-cookie/1.4.1/jquery.cookie.min.js"></script>
        <link rel='stylesheet' href='https://www.firebase.com/resources/tutorial/css/example.css'/>
        <link rel='stylesheet' href='css/style.css'/>
    </head>

    <body ng-controller="MyController">
        <div class='example-chat l-demo-container'>
            <header >Game {{ game.$id }}</header>

            <div class='example-chat-toolbar' ng-model='question'>
                {{ question.Q }}
            </div>

            <ul id='example-messages' class='example-chat-messages'>
                <li ng-repeat='user in game.users'>
                <strong class='example-chat-username'>{{ user }}</strong>
                    {{ lie }}
                </li>
                
                <hr/>

                <div id="options_container" class="hide">
                    <div ng-repeat="(_, choice) in choices">
                        <input type="button" value="{{ choice }} " class="button" ng-click="vote(this)"/>
                    </div>
                </div>
            </ul>

            <footer>
                <input id="lie" ng-model='inputLie' ng-keydown="enterLie($event)" type='text' id='messageInput'  placeholder='Type a lie...'>
            </footer>
        </div>

    <script>
        var id = "-JhWr1YifZ_GoNuUE1ig";
        var username;
        if (false) {
            // $.cookie('sucker', username, { expires: 7, path: '/' });
            username = "Jonny";
        } else {
            var username = $.cookie('sucker');
            while (!username) {
                username = prompt("Please input a username.");
            }
            $.cookie('sucker', username, { expires: 7, path: '/' });
        }

        var myApp = angular.module("myApp", ["firebase"]);
        myApp.controller('MyController', ['$scope', '$firebase', 
            function($scope, $firebase) {
                var gameReference = new Firebase("https://sucker.firebaseio.com/game/" + id);
                $scope.game = $firebase(gameReference).$asObject();          

                var round = $firebase(gameReference.child("rounds")).$asObject();
                $scope.question = "Loading question..."; // get question object
                var questionReference = new Firebase("https://sucker.firebaseio.com/questions/000");
                questionReference.on("value", function(snapshot) {
                    $scope.question = snapshot.val(); //get question

                    round.$loaded().then(function () {
                        if (!round[$scope.question.Q]) {
                            round[$scope.question.Q] = {"choices": {"computer": $scope.question.A}};
                        }
                        round.$save(); //save question to firebase

                        var choiceRef = new Firebase("https://sucker.firebaseio.com/game/" + id + "/rounds/" + $scope.question.Q + "/choices");
                        $scope.choices = $firebase(choiceRef).$asObject();
                    });
                });

                $scope.enterLie = function(e, force) {
                    if (force || e.keyCode === 13 && $scope.inputLie) {
                        $scope.choices[username] = $scope.lie = $scope.inputLie ? $scope.inputLie : "No Answer";
                        $scope.choices.$save();
                        if (!force) {
                            $scope.showChoices();
                            $scope.inputLie = undefined;
                        }
                    }
                }

                $scope.showChoices = function() {
                    $scope.enterLie(undefined, true);
                    $("#options_container").removeClass("hide");
                    $("#lie").addClass("hide");
                }

                $scope.vote = function(e) {
                    // alert("Not implemented yet.);")
                    console.log(e);
                    for (var a in $scope.choices) {
                        if ($scope.choices[a] == e.choice) {
                            console.log("true");
                            console.log(!$scope.choices[a].hasOwnProperty("voters"));
                            if (!$scope.choices[a].hasOwnProperty("voters")) {
                                $scope.choices[a].voters = username;
                            } else {
                                $scope.choices[a].voters.push(username);
                            }
                            $scope.choices.$save();
                        }
                    }
                }
      }]);
    </script>
    </body>
</html>
