<!DOCTYPE HTML>
<!--
    Astral by HTML5 UP
    html5up.net | @n33co
    Free for personal and commercial use under the CCA 3.0 license (html5up.net/license)
-->
<html ng-app="myApp">
    <head>
        <title>Sucker</title>
        <meta http-equiv="content-type" content="text/html; charset=utf-8" />
        <meta name="description" content="" />
        <meta name="keywords" content="" />

        <!-- MY SHIT -->
        <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.3.10/angular.min.js"></script>
        <script src="https://cdn.firebase.com/js/client/2.1.1/firebase.js"></script>
        <script src="https://cdn.firebase.com/libs/angularfire/0.9.2/angularfire.min.js"></script>
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-cookie/1.4.1/jquery.cookie.min.js"></script>
        <script src="js/game.js"></script>
        <!-- -->

        <!--[if lte IE 8]><script src="css/ie/html5shiv.js"></script><![endif]-->
        <script src="js/jquery.min.js"></script>
        <script src="js/skel.min.js"></script>
        <script src="js/init.js"></script>
        <noscript>
            <link rel="stylesheet" href="css/skel.css" />
            <link rel="stylesheet" href="css/style.css" />
            <link rel="stylesheet" href="css/style-desktop.css" />
            <link rel="stylesheet" href="css/style-noscript.css" />
        </noscript>

        <link rel='stylesheet' href='css/firebase.css'/>
        <link rel='stylesheet' href='css/handanimation.css'/>
        <link rel='stylesheet' href='css/style.css'/>
        <link rel='stylesheet' type='text/css' media='all' href='css/animate.css'/>
        <!--[if lte IE 8]><link rel="stylesheet" href="css/ie/v8.css" /><![endif]-->
    </head>
    <body ng-controller="MyController">

        <!-- Wrapper-->
        <div id="wrapper">
                
            <!-- Nav -->
            <nav id="nav">
                <a href="#me" class="icon fa-home active"><span>Home</span></a>
                <a href="#create" class="icon fa-plus-circle"><span>Create</span></a>
                <a href="#join" class="icon fa-user"><span>Join</span></a>
                <a href="#info" class="icon fa-info-circle"><span>Info</span></a>
            </nav>

            <!-- Main -->
            <div id="main">                  
                <!-- Me -->
                <article id="me" class="panel">
                    <div id='pregame' class='center'>
                        <img src="http://blog.flamingtext.com/blog/2015/03/09/flamingtext_com_1425864309_282458501.png" border="0" alt="Logo Design by FlamingText.com" title="Logo Design by FlamingText.com">
                        <br>
                        <br>
                        <a href="#create" class="jumplink"><input class="gameButton" type="button" value="Create Game" ng-click="showLobby()"/></a>
                        <a href="#join" class="jumplink"><input class="gameButton" type="button" value="Join Game" ng-click="showJoin()"/></a>
                        <a href="#info" class="jumplink"><input class="gameButton" type="button" value="Info" ng-click=""/></a>
                    </div>   
                </article>

                <!-- Work --> 
                <article id="create" class="panel">
                   <div id="lobby" class="lobby">
                        <div class="players">
                            <center>
                                <h3>PLAYERS</h3>
                                 <span ng-repeat="(username, _) in users">
                                    {{ username }}
                                <br>
                                 </span> 

                             </center>
                        </div>

                        <div class="welcome">
                            <center>
                                <h2> Welcome!</h2>
                                <br>
                                 <input id = "username" class="usernameInput" type="text" size= "27" ng-model='inputUsername' placeholder="Please enter username" ng-keydown="enterUsername($event)"/>
                                 <br><br>
                                <p>Your invite code is:</p>
                                <div>{{ game.$id }}</div>
                                <div id = "startGame" class = 'footer'>
                                    <br><br>
                                    <input id="startButton" class="gameButton" type="button" value="Start Game" ng-click="startGame()" disabled/>
                                </div>
                            </center>
                        </div>

                    </div>

                    <div id="app" class="init hide">
                        <h3>Welcome {{ username }} : Game {{ game.$id }}</h3>
                        <br>

                        <div id="question" class='' ng-model='question'>
                            {{ question }}
                        </div>
                        <div id="gameover" class="hide">
                            GAME OVER.
                        </div>

                        <div id="waiting" class="hide">
                            Waiting for other players...
                          <div>
                            <svg fill="#76daff" width="70" height="20">
                              <rect width="20" height="20" x="0" y="0" rx="3" ry="3">
                                <animate attributeName="width" values="0;20;20;20;0" dur="1000ms" repeatCount="indefinite"/>
                                <animate attributeName="height" values="0;20;20;20;0" dur="1000ms" repeatCount="indefinite"/>
                                <animate attributeName="x" values="10;0;0;0;10" dur="1000ms" repeatCount="indefinite"/>
                                <animate attributeName="y" values="10;0;0;0;10" dur="1000ms" repeatCount="indefinite"/>
                              </rect>
                              <rect width="20" height="20" x="25" y="0" rx="3" ry="3">
                                <animate attributeName="width" values="0;20;20;20;0" begin="200ms" dur="1000ms" repeatCount="indefinite"/>
                                <animate attributeName="height" values="0;20;20;20;0" begin="200ms" dur="1000ms" repeatCount="indefinite"/>
                                <animate attributeName="x" values="35;25;25;25;35" begin="200ms" dur="1000ms" repeatCount="indefinite"/>
                                <animate attributeName="y" values="10;0;0;0;10" begin="200ms" dur="1000ms" repeatCount="indefinite"/>
                              </rect>
                              <rect width="20" height="20" x="50" y="0" rx="3" ry="3">
                                <animate attributeName="width" values="0;20;20;20;0" begin="400ms" dur="1000ms" repeatCount="indefinite"/>
                                <animate attributeName="height" values="0;20;20;20;0" begin="400ms" dur="1000ms" repeatCount="indefinite"/>
                                <animate attributeName="x" values="60;50;50;50;60" begin="400ms" dur="1000ms" repeatCount="indefinite"/>
                                <animate attributeName="y" values="10;0;0;0;10" begin="400ms" dur="1000ms" repeatCount="indefinite"/>
                              </rect>
                            </svg>
                          </div>
                        </div>

                        <div id="answer" class="hide">
                            You chose: <strong id="choiceId"></strong><br>
                            The correct answer is: <strong>{{ answer }}</strong>
                            <hr/>
                        </div>

                        <div id="options_container" class="buttons hide">
                            <input ng-repeat="(_, choice) in choices" id="displayLies" type="button" value="{{ choice }} " class="button" ng-click="vote(this)"/>
                        </div>

                        <ul id="users" class="hide">
                            <li ng-repeat="(username, points) in users">{{ username }} [{{ points }}]</li>
                        </ul>

                        <footer>
                            <input id="lie" ng-model='inputLie' ng-keydown="enterLie($event)" type='text' placeholder='Type a lie...' class="hide">
                            <div>
                                Timer: <span id="time">10</span>
                            </div>
                        </footer>
                    </div>                    
                </article>

                <!-- Join a Game -->
                <article id="join" class="panel">
                        <div class="joingame">
                            <center>
                            <h2>JOIN A GAME</h2><br>
                            <input class="usernameInput" type="text" ng-model='inputUsername' placeholder="Enter username"/>
                            <input id="gameIDInput" type="text" ng-model='inputGameID' placeholder="Enter game ID"/>
                            <br><br>
                            <a href="#create" class="jumplink"><input class="gameButton" type="button" value="Join" ng-click="storeGameID()"/></a>
                            </center>
                        </div>
                </article>

                <article id="info" class="panel">
                    <h1>Information</h1>
                    <br>
                    <p>Sucker is an extremely fun and easy game to play with your friends and family.  It is a test on your knowledge of random facts, on how good you are at lying on the spot, and on just how good you are at fooling your friends.</p>
                    <p>To start a game of Sucker, you must create a game by entering a username in the Lobby to retrieve a game code to be shared with whomever you wish to play the game with.  To join a game, you must enter a username and game code of the Lobby you wish to join.  Once all desired players enter the Lobby, someone can start the game.  A random question or statement with a blank line will then show up on your screen and your job is to input a lie that you feel will be the most believable.  Once all players of the game input a lie, You choose which answer you believe to be the truth.</p>
                    <h3>Point System</h3>
                    <p>A user gains points if:</p>
                    <ul>
                        <li>another player selects their answer.</li>
                        <li>the user select the correct answer.</li>
                    </ul>
                    <h3>Stretch Features</h3>
                    <ul>
                        <li>computer generated lie</li>
                    </ul>
                    <h3>Rest API Info</h3>
                    <ul>
                        <li>AWS ec2 instance running an Apache</li>                        
                        <li>Firebase for our database because we want real time push notifications</li>
                        <li>AngularJs to bind Firebase data to the DOM.</li>
                    </ul>

                </article>
            </div>
       </div>


    
    <!-- MY SHIT -->        
   <script>
        var showLogin = function(show) {
            // if (show) {
            //     $("#login").removeClass("hide");
            //     $("#app").addClass("hide");
            // } else {
            //     $("#login").addClass("hide");
            //     $("#app").removeClass("hide");
            // }
        }

        var joinGameId;
        var username;
        var ref;
        showLogin(true);

        // Check if a username exists
        // if (document.URL.indexOf(".html") >= 0) {
        //     username = "LocalUser";
        //     showLogin(false);
        // } else {
        //     username = $.cookie('sucker');
        //     if (username) {
        //         showLogin(false);
        //     }
        // }

        var game;

        var firstTime = true;

        var myApp = angular.module("myApp", ["firebase"]);
        myApp.controller('MyController', ['$scope', '$firebase',
            function($scope, $firebase) {

                //username = "Guest";
                $scope.username = username;
                var sucker = new Firebase("https://sucker.firebaseio.com");
                $scope.users = {};

                var update = function() {
                    if (game) {
                        $scope.$apply(function() {
                            // this will update the bindings
                            $scope.users = game.game.users;
                        });
                    }
                    if (game && game.game.state != Game.State.PREGAME) {
                        if (firstTime) {
                            $scope.showGame();
                            firstTime = false;
                        }
                        $scope.activeUsers = game.getActiveUsers();
                        $scope.leftoverTime = game.getLeftoverTime();
                        var timer = game.update((new Date().getTime()) + $scope.leftoverTime);
                        console.log(timer);
                        if($scope.activeUsers == 0) {
                            $scope.leftoverTime += timer * 1000;
                            game.setLeftoverTime($scope.leftoverTime);
                            game.setActiveUsers(game.getNumUsers());
                        }
                        $("#time").html(Math.max(0, timer));
                    }
                }
                var stopUpdate = setInterval(update, 5);

                $scope.showLobby = function() {
                    $("#lobby").removeClass("hide");
                    $('#lobby').removeClass('init');
                    $("#gameover").addClass("hide");
                    $("#app").removeClass("hide");
                    $("#app").addClass("init");
                    $("#waiting").addClass("hide");
                }

                $scope.createGame = function() {
                    //$scope.showLobby();

                    var gameReference = sucker.child("game");
                    var newGame = gameReference.push({
                        round: -1,
                        users: {username: {points: 0}},
                        activeUsers: 0,
                        leftoverTime: 0,
                        taken: [0, 0, 0, 0],
                        numUsers: 0
                    });

                     // TODO: Hacky =\. We just want this game as an object.
                    var id = newGame.path.u[1];
                    ref = new Firebase("https://sucker.firebaseio.com/game/" + id);
                    $scope.game = $firebase(ref).$asObject();

                    game = new Game(username, $scope.game, 4, {
                        "PREGAME" : $scope.showWaiting,
                        "STARTED" : $scope.showWaiting,
                        "INPUT_LIE" : $scope.showEnterLie,
                        "VOTE" : $scope.showChoices,
                        "DISPLAY_RESULTS" : $scope.showResults,
                        "GAMEOVER" : $scope.showGameOver
                    });

                    $scope.users = game.users;
                    $scope.activeUsers = game.activeUsers;
                    $scope.leftoverTime = game.leftoverTime;
                    $scope.taken = game.taken;
                    $scope.numUsers = game.numUsers;

                    $.getJSON("https://sucker.firebaseio.com/questions.json",
                        function(data, status, xhr) {
                            // TODO: randomize, but make sure it only gets set *once*
                            var questions = [];
                            // for (var i = 0; i < 4; ++i) {
                            //     questions[i] = data[i];
                            // }
                            var taken = [];
                            var ndx;
                            for (var i = 0; i < 4; ++i) {
                                ndx = Math.floor(Math.random() * 30);
                                for(var j = 0; j < i; ++j) {
                                    if(taken[j] == ndx) {
                                        ndx = Math.floor(Math.random() * 30);
                                        j = 0;
                                    }
                                }
                                questions[i] = data[ndx];
                                taken[i] = ndx;
                            }

                            game.setQuestions(questions, taken);
                    });
                }

                $scope.storeGameID = function() {
                    if ($scope.inputUsername && $scope.inputGameID) {
                        document.getElementById("username").disabled = true; 
                        document.getElementById("startButton").disabled = false; 
                        username = $scope.inputUsername;
                        $scope.inputUsername = "";
                        joinGameId = $scope.inputGameID;
                        $scope.inputGameID = "";
                        $scope.joinGame();
                    }
                }

                $scope.joinGame = function() {
                    ref = new Firebase("https://sucker.firebaseio.com/game/" + joinGameId);
                    $scope.game = $firebase(ref).$asObject();

                    $scope.game.$loaded().then(function(data) {
                        game = new Game(username, $scope.game, 4, {
                            "PREGAME" : $scope.showWaiting,
                            "STARTED" : $scope.showWaiting,
                            "INPUT_LIE" : $scope.showEnterLie,
                            "VOTE" : $scope.showChoices,
                            "DISPLAY_RESULTS" : $scope.showResults,
                            "GAMEOVER" : $scope.showGameOver
                        });
                        $scope.users = game.users;
                        $scope.activeUsers = game.activeUsers;
                        $scope.leftoverTime = game.leftoverTime;
                        $scope.taken = game.taken;
                        $scope.numUsers = game.numUsers;

                        var questions = [];
                        var taken = [];
                        $.getJSON("https://sucker.firebaseio.com/game/" + joinGameId + "/taken.json",
                                    function(data, status, xhr) {
                            // TODO: randomize, but make sure it only gets set *once*
                            for (var i = 0; i < 4; ++i) {
                                taken[i] = data[i];
                                console.log(i + ":" + data[i]);
                            }
                            $.getJSON("https://sucker.firebaseio.com/questions.json",
                                function(moarData, status, xhr) {
                                    for (var j = 0; j < 4; ++j) {
                                        questions[j] = moarData[taken[j]];
                                    }
                                game.setQuestions(questions, taken);
                            });
                        });

                        $scope.showLobby();
                       // $("#pregame").addClass("hide");
                       // $("#join").removeClass("hide");
                       // $("#startButton").addClass("hide");
                       // $("#createButton").addClass("hide");
                       // $("#joinButton").addClass("hide");
                    });
                }

                $scope.showGame = function() {
                    $("#lobby").addClass("hide");
                    $("#app").removeClass("init");
                    $("#gameover").addClass("hide");
                    $("#app").removeClass("hide");
                    $("#startButton").addClass("hide");
                    $("#waiting").addClass("hide");
                }


                $scope.startGame = function() {
                    console.log("Starting game..");
                    $scope.showGame();

                    // TODO: Use Firbase's server time because not everyone's
                    // computer will sync perfectly
                    var date = new Date();
                    var time = date.getTime();

                    var times = {};

                    $scope.numUsers = Object.keys($scope.users).length;
                    $scope.activeUsers = Object.keys($scope.users).length;
                    // numUsers = $scope.activeUsers;
                    // console.log("start active users: " + numUsers);

                    // for each round
                    // TODO: remove magic numero 4
                    for (var round = 0; round < 4; ++round) {
                        console.log("check");
                        if (round) {time += 25000;}
                        times[time] = {state: Game.State.INPUT_LIE, round: round};

                        time += 25000;
                        times[time] = {state: Game.State.VOTE, round: round};

                        time += 25000;
                        times[time] = {state: Game.State.DISPLAY_RESULTS, round: round};
                    }

                    // GAMEOVER
                    time += 25000;
                    times[time] = {state: Game.State.GAMEOVER, round: 4}; // TODO: magic #
                    console.log(times);
                    game.setTimes(times);
                    game.setNumUsers($scope.numUsers);
                    game.setActiveUsers($scope.activeUsers);
                    console.log("set active users: " + game.getActiveUsers());
                    game.start();
                    $scope.showEnterLie();
                }

                $scope.showEnterLie = function() {
                    console.log("$scope.showEnterLie");

                    $("#gameover").addClass("hide");
                    $("#waiting").addClass("hide");
                    $("#answer").addClass("hide");
                    $("#lie").removeClass("hide");
                    $("#options_container").addClass("hide");
                    $("#users").addClass("hide");
                    $scope.activeUsers = game.getActiveUsers();
                    $scope.question = game.getQuestion();
                    $scope.choices = game.getChoices();
                    //game.setActiveUsers($scope.activeUsers);
                }

                $scope.enterLie = function(e) {
                    if (e.keyCode === 13 && $scope.inputLie) {
                        var str = $scope.inputLie.toUpperCase();
                        var answer = game.getAnswer();
                        if(answer.indexOf(str) != -1)
                        {
                            document.getElementById("lie").value = "";
                            alert("Congrats! You input the correct answer.  Please enter another lie.");
                        }
                        else
                        {
                            game.addChoice(username, str);
                            $scope.inputLie = "";
                            $scope.showWaiting();
                        }
                    }

                    document.getElementById("choiceId").innerHTML = "";
                }

                $scope.enterUsername = function(e) {
                    if (e.keyCode === 13 && $scope.inputUsername) {
                        document.getElementById("startButton").disabled = false;    
                        username = $scope.inputUsername;
                        $scope.inputUsername = "";
                        $scope.createGame();
                        document.getElementById("username").disabled = true; 
                    }
                }

                $scope.showWaiting = function() {
                    console.log("waiting...");
                    $("#gameover").addClass("hide");
                    $("#waiting").removeClass("hide");
                    $("#answer").addClass("hide");
                    $("#lie").addClass("hide");
                    $("#options_container").addClass("hide");

                    $scope.activeUsers = game.getActiveUsers();
                    $scope.activeUsers--;
                    game.setActiveUsers($scope.activeUsers);
                    console.log("activeUsers: " + $scope.activeUsers);
                }

                $scope.showChoices = function() {
                    console.log("$scope.showChoices");

                    $scope.activeUsers = game.getActiveUsers();
                    console.log("vote: " + game.getActiveUsers());
                    //game.setActiveUsers($scope.activeUsers);

                    $scope.choices = game.getChoices();
                    $("#gameover").addClass("hide");
                    $("#waiting").addClass("hide");
                    $("#answer").addClass("hide");
                    $("#lie").addClass("hide");
                    $("#options_container").addClass("option animated bounceInDown");
                    $("#options_container").removeClass("hide");
                }

                $scope.vote = function(e) {
                    // If player chooses the truth
                    if (game.getAnswer() == e.choice) {
                        game.addPoints(100);
                    }
                    else {
                        // If player chooses someone's lie
                        var usersArr = Object.getOwnPropertyNames($scope.users);
                        for (var i = 0; i < usersArr.length; i++) {
                            if ($scope.choices[usersArr[i]] == e.choice) {
                                $scope.users = game.addLiePoints(usersArr[i], 50);
                            }
                        }
                    }

                    document.getElementById("choiceId").innerHTML = e.choice;
                    $scope.showWaiting();
                }

                $scope.showJoin = function() {
                    $('#lobby').removeClass('init');
                    $("#gameover").addClass("hide");
                    $("#app").removeClass("hide");
                    $("#waiting").addClass("hide");
                }

                $scope.showResults = function() {
                    console.log("$scope.showResults");
                    $scope.answer = game.getAnswer();

                    $("#gameover").addClass("hide");
                    $("#waiting").addClass("hide");
                    $("#answer").removeClass("hide");
                    $("#lie").addClass("hide");
                    $("#options_container").addClass("hide");
                    $("#users").removeClass("hide");
                }

                $scope.showGameOver = function() {
                    $("#gameover").removeClass("hide");
                    $("#waiting").addClass("hide");
                    $("#answer").addClass("hide");
                    $("#lie").addClass("hide");
                    $("#options_container").addClass("hide");
                    $("#question").addClass("hide");
                    function end() {
                        ref.remove();
                    }
                    setTimeout(end, 25000);
                    function afterEnd() {
                        clearInterval(stopUpdate);
                    }
                    setTimeout(afterEnd, 25000);
                }

      }]);
    </script>
    </body>
</html>